<!DOCTYPE html>
<html>
<head>
<title id="pageTitle">学习计划时间表生成器</title>
<meta charset="UTF-8">
<style>
a{text-decoration: none;color:#39f; }
body{width: 988px; margin: 0 auto;}
th{text-align: right; font-size: 14px; color: #666;width: 100px;}
td{font-size: 12px;color: #999;padding: 3px 0;}
input{width: 136px;}
input[type=checkbox]{width:auto;}
select{width: 142px;}
h1{text-align: center;}
#sidebar{float: left;width: 270px;margin-right: 10px;margin-top: 70px;}
#output{width: 707px;font-family: Verdana;float: left;font-size: 12px;}
#output>span{
	width: 100px;
	float: left;
	height: 20px;
	border: 1px solid #aaa;
	border-left: none;
	text-align: center;
}
#output{border-left: 1px solid #aaa;}
#calendar>div{
	width: 97px;
	height: 114px;
	float: left;
	padding-left: 3px;
	border-right: 1px solid #aaa;
	border-bottom: 1px solid #aaa;
}
@media print{form{display: none;}body{width: 708px;} .info-section{display: none;}}

/* 颜色区分样式 */
.new-study { color: #007700; font-weight: bold; }
.review { color: #aa0000; }

/* 语言切换按钮样式 */
.lang-switch {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
}
.lang-switch:hover {
    background: #e0e0e0;
}

/* 说明文档样式 */
.info-section {
    clear: both;
    margin-top: 30px;
    padding: 20px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.info-section h2 {
    margin-top: 0;
    color: #333;
    font-size: 18px;
}
.info-section h3 {
    color: #666;
    font-size: 16px;
    margin-top: 20px;
}
.info-section ul {
    padding-left: 20px;
}
.info-section li {
    margin-bottom: 8px;
    line-height: 1.5;
}
.info-section p {
    line-height: 1.6;
    margin-bottom: 15px;
}
.collapse-header {
    cursor: pointer;
    background: #e8e8e8;
    padding: 10px 15px;
    margin: -20px -20px 20px -20px;
    border-bottom: 1px solid #ddd;
    user-select: none;
}
.collapse-header:hover {
    background: #e0e0e0;
}
.collapse-content {
    display: none;
}
.collapse-content.expanded {
    display: block;
}
.collapse-arrow {
    float: right;
    transition: transform 0.3s;
}
.collapse-arrow.expanded {
    transform: rotate(90deg);
}
</style>
</head>
<body>

<button class="lang-switch" onclick="toggleLanguage()" id="langBtn">English</button>

<form id="sidebar">
    <table>
        <tbody>
        <tr><th id="planLabel">计划名</th><td><input id="plan" value="Your title"></td></tr>
        <tr><th id="bookLabel">List 名</th><td><input id="book" value="L"></td></tr>
        <tr><th id="startDateLabel">开始日期</th><td><input id="startDate" type="date"></td></tr>
        <tr><th id="listPerDayLabel">每天 List 数</th><td><input id="listPerDay" value="2"></td></tr>
        <tr><th id="totalListLabel">List 总数</th><td><input id="totalList" value="42"></td></tr>
        <tr><th id="reverseLabel">是否逆序</th><td><input id="reverse" type="checkbox"></td></tr>
        <tr><th id="colorLabel">颜色区分</th><td><input id="colorEnabled" type="checkbox" checked></td></tr>
        <tr><th id="weekStartLabel">周日第一天</th><td><input id="sundayFirst" type="checkbox"></td></tr>
        <tr><th id="intervalLabel">复习间隔</th><td>
            <input id="reviewInterval" value="0,1,3,7,14,25" title="复习间隔（天数），用逗号分隔">
        </td></tr>
        <tr><th id="actionLabel">操作</th><td>
            <button type="button" onclick="window.print()" id="printBtn">打印</button>
            <button type="button" id="exportPNG">导出PNG</button>
            <button type="button" id="exportPDF">导出PDF</button>
            <button type="button" id="exportExcel">导出Excel</button>
            <button type="button" id="exportHTML">导出HTML</button>
            <button type="button" id="restoreDefaultReviewInterval" onclick="restoreDefaultReviewIntervalFunction()">恢复默认复习间隔</button>
        </td></tr>
        </tbody>
    </table>
    <br>
</form>

<h1 id="mainTitle">学习计划时间表生成器</h1>
<div id="output">
    <span id="day0">Sun</span><span id="day1">Mon</span><span id="day2">Tue</span>
    <span id="day3">Wed</span><span id="day4">Thu</span><span id="day5">Fri</span><span id="day6">Sat</span>
    <div id="calendar"></div>
</div>

<!-- 使用说明 -->
<div class="info-section">
    <h2 id="usageTitle">使用说明</h2>
    <ul id="usageList">
        <li>1. 填写计划名称和List名称（如：单词、课程等）</li>
        <li>2. 选择开始日期和每天要学习的List数量</li>
        <li>3. 输入总的List数量</li>
        <li>4. 设置复习间隔（默认：0,1,3,7,14,25天），可根据需要调整</li>
        <li>5. 勾选相关选项（逆序、颜色区分、周日第一天）</li>
        <li>6. 设置相关配置，系统会立即自动安排学习和复习计划</li>
        <li>7. 可导出为PNG、PDF、Excel或HTML格式保存使用</li>
    </ul>
</div>

<!-- 理论基础 -->
<div class="info-section">
    <div class="collapse-header" onclick="toggleTheorySection()">
        <h2 id="theoryTitle"><span class="collapse-arrow">▶</span> 理论基础：艾宾浩斯遗忘曲线</h2>
        <small id="theoryToggle">点击展开/收起</small>
    </div>
    <div class="collapse-content" id="theoryContent">
        <p id="theoryIntro">遗忘曲线（Forgetting curve）是用于表述记忆中的中长期记忆的遗忘率的一种曲线。这一曲线最早由心理学家赫尔曼·艾宾浩斯通过自己的实验提出。</p>
        
        <p id="theoryProcess">记忆的保持在时间上是不同的，有短时记忆和长时记忆两种。输入的信息在经过人的注意过程的学习后，便成为了人的短时的记忆，再经过进一步强化后成为长时记忆。如果不经过及时的复习，这些记住过的东西就会遗忘，而经过了及时的复习，长时记忆就会继续保持下去。</p>
        
        <h3 id="theoryResults">遗忘结果：</h3>
        <ul id="theoryDataList">
            <li>20分钟后，42%被遗忘掉，58%被记住</li>
            <li>1小时后，56%被遗忘掉，44%被记住</li>
            <li>1天后，74%被遗忘掉，26%被记住</li>
            <li>1周后，77%被遗忘掉，23%被记住</li>
            <li>1个月后，79%被遗忘掉，21%被记住</li>
        </ul>
        
        <p id="theoryConclusion">因此，科学的复习时间安排对于长期记忆非常重要。本工具基于遗忘曲线原理，帮助您制定科学的学习和复习计划。</p>
    </div>
</div>

<script src="./js/jquery-latest.min.js"></script>
<script src="./js/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="./js/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./js/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// 默认复习间隔
const DEFAULT_REVIEW_INTERVAL = "0,1,3,7,14,25";

// 语言配置
const languages = {
    zh: {
        pageTitle: "学习计划时间表生成器",
        mainTitle: "学习计划时间表生成器",
        planLabel: "计划名",
        bookLabel: "List 名",
        startDateLabel: "开始日期",
        listPerDayLabel: "每天 List 数",
        totalListLabel: "List 总数",
        reverseLabel: "是否逆序",
        colorLabel: "颜色区分",
        weekStartLabel: "周日第一天",
        intervalLabel: "复习间隔",
        actionLabel: "操作",
        restoreDefaultReviewInterval: "恢复默认复习间隔",
        printBtn: "打印",
        exportPNG: "导出PNG",
        exportPDF: "导出PDF",
        exportExcel: "导出Excel",
        exportHTML: "导出HTML",
        langBtn: "English",
        days: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
        daysLong: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
        // 使用说明
        usageTitle: "使用说明",
        usageContent: [
            "1. 填写计划名称和List名称（如：单词、课程等）",
            "2. 选择开始日期和每天要学习的List数量",
            "3. 输入总的List数量",
            "4. 设置复习间隔（默认：0,1,3,7,14,25天），可根据需要调整",
            "5. 勾选相关选项（逆序、颜色区分、周日第一天）",
            "6. 设置相关配置，系统会立即自动安排学习和复习计划",
            "7. 可导出为PNG、PDF、Excel或HTML格式保存使用"
        ],
        // 理论基础
        theoryTitle: "理论基础：艾宾浩斯遗忘曲线",
        theoryToggle: "点击展开/收起",
        theoryIntro: "遗忘曲线（Forgetting curve）是用于表述记忆中的中长期记忆的遗忘率的一种曲线。这一曲线最早由心理学家赫尔曼·艾宾浩斯通过自己的实验提出。",
        theoryProcess: "记忆的保持在时间上是不同的，有短时记忆和长时记忆两种。输入的信息在经过人的注意过程的学习后，便成为了人的短时的记忆，再经过进一步强化后成为长时记忆。如果不经过及时的复习，这些记住过的东西就会遗忘，而经过了及时的复习，长时记忆就会继续保持下去。",
        theoryResults: "遗忘结果：",
        theoryData: [
            "20分钟后，42%被遗忘掉，58%被记住",
            "1小时后，56%被遗忘掉，44%被记住", 
            "1天后，74%被遗忘掉，26%被记住",
            "1周后，77%被遗忘掉，23%被记住",
            "1个月后，79%被遗忘掉，21%被记住"
        ],
        theoryConclusion: "因此，科学的复习时间安排对于长期记忆非常重要。本工具基于遗忘曲线原理，帮助您制定科学的学习和复习计划。"
    },
    en: {
        pageTitle: "Study Plan Calendar Generator",
        mainTitle: "Study Plan Calendar Generator",
        planLabel: "Plan Name",
        bookLabel: "List Name",
        startDateLabel: "Start Date",
        listPerDayLabel: "Lists per Day",
        totalListLabel: "Total Lists",
        reverseLabel: "Reverse Order",
        colorLabel: "Color Coding",
        weekStartLabel: "Sunday First",
        intervalLabel: "Review Interval",
        actionLabel: "Actions",
        restoreDefaultReviewInterval: "Restore Default Review Interval",
        printBtn: "Print",
        exportPNG: "Export PNG",
        exportPDF: "Export PDF",
        exportExcel: "Export Excel",
        exportHTML: "Export HTML",
        langBtn: "中文",
        days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        daysLong: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        // Usage Instructions
        usageTitle: "Usage Instructions",
        usageContent: [
            "1. Enter plan name and list name (e.g., Vocabulary, Lessons, etc.)",
            "2. Select start date and number of lists to study per day",
            "3. Enter total number of lists",
            "4. Set review intervals (default: 0,1,3,7,14,25 days), adjustable as needed",
            "5. Check relevant options (reverse order, color coding, Sunday first)",
            "6. Set the relevant configurations, and the system will automatically arrange the study and review schedule immediately.",
            "7. Export as PNG, PDF, Excel or HTML format for later use"
        ],
        // Theory Background
        theoryTitle: "Theory Background: Ebbinghaus Forgetting Curve",
        theoryToggle: "Click to expand/collapse",
        theoryIntro: "The forgetting curve is a mathematical formula that describes the rate at which information is forgotten after it is learned. It was first described by Hermann Ebbinghaus through his experiments on memory.",
        theoryProcess: "Memory retention varies over time, with short-term and long-term memory. Information becomes short-term memory after attention and learning, then becomes long-term memory through further reinforcement. Without timely review, memorized information will be forgotten, but with timely review, long-term memory will continue to be maintained.",
        theoryResults: "Forgetting Results:",
        theoryData: [
            "After 20 minutes, 42% forgotten, 58% retained",
            "After 1 hour, 56% forgotten, 44% retained",
            "After 1 day, 74% forgotten, 26% retained", 
            "After 1 week, 77% forgotten, 23% retained",
            "After 1 month, 79% forgotten, 21% retained"
        ],
        theoryConclusion: "Therefore, scientific review scheduling is crucial for long-term memory. This tool is based on the forgetting curve principle to help you create a scientific study and review plan."
    }
};

let currentLang = 'zh';

// 保存设置到localStorage
function saveSettings() {
    const settings = {
        plan: document.getElementById("plan").value,
        book: document.getElementById("book").value,
        startDate: document.getElementById("startDate").value,
        listPerDay: document.getElementById("listPerDay").value,
        totalList: document.getElementById("totalList").value,
        reverse: document.getElementById("reverse").checked,
        colorEnabled: document.getElementById("colorEnabled").checked,
        sundayFirst: document.getElementById("sundayFirst").checked,
        reviewInterval: document.getElementById("reviewInterval").value,
        currentLang: currentLang
    };
    localStorage.setItem('studyPlanSettings', JSON.stringify(settings));
}

// 从localStorage加载设置
function loadSettings() {
    const savedSettings = localStorage.getItem('studyPlanSettings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            document.getElementById("plan").value = settings.plan || "Your title";
            document.getElementById("book").value = settings.book || "L";
            document.getElementById("startDate").value = settings.startDate || new Date().toISOString().slice(0, 10);
            document.getElementById("listPerDay").value = settings.listPerDay || "2";
            document.getElementById("totalList").value = settings.totalList || "42";
            document.getElementById("reverse").checked = settings.reverse || false;
            document.getElementById("colorEnabled").checked = settings.colorEnabled !== undefined ? settings.colorEnabled : true;
            document.getElementById("sundayFirst").checked = settings.sundayFirst !== undefined ? settings.sundayFirst : true;
            document.getElementById("reviewInterval").value = settings.reviewInterval || DEFAULT_REVIEW_INTERVAL;
            currentLang = settings.currentLang || 'zh';
        } catch (e) {
            console.error('加载设置失败:', e);
        }
    } else {
        // 如果没有保存的设置，使用默认值
        document.getElementById("startDate").value = new Date().toISOString().slice(0, 10);
    }
}

// 恢复默认复习间隔
function restoreDefaultReviewIntervalFunction() {
    document.getElementById("reviewInterval").value = DEFAULT_REVIEW_INTERVAL;
    saveSettings();
    renderCalendar();
}

function toggleLanguage() {
    currentLang = currentLang === 'zh' ? 'en' : 'zh';
    updateLanguage();
    saveSettings();
    renderCalendar();
}

function updateLanguage() {
    const lang = languages[currentLang];
    
    // 更新页面标题和各种标签
    document.getElementById('pageTitle').textContent = lang.pageTitle;
    document.getElementById('mainTitle').textContent = lang.mainTitle;
    document.getElementById('planLabel').textContent = lang.planLabel;
    document.getElementById('bookLabel').textContent = lang.bookLabel;
    document.getElementById('startDateLabel').textContent = lang.startDateLabel;
    document.getElementById('listPerDayLabel').textContent = lang.listPerDayLabel;
    document.getElementById('totalListLabel').textContent = lang.totalListLabel;
    document.getElementById('reverseLabel').textContent = lang.reverseLabel;
    document.getElementById('colorLabel').textContent = lang.colorLabel;
    document.getElementById('weekStartLabel').textContent = lang.weekStartLabel;
    document.getElementById('intervalLabel').textContent = lang.intervalLabel;
    document.getElementById('actionLabel').textContent = lang.actionLabel;
    document.getElementById('restoreDefaultReviewInterval').textContent = lang.restoreDefaultReviewInterval;
    document.getElementById('printBtn').textContent = lang.printBtn;
    document.getElementById('exportPNG').textContent = lang.exportPNG;
    document.getElementById('exportPDF').textContent = lang.exportPDF;
    document.getElementById('exportExcel').textContent = lang.exportExcel;
    document.getElementById('exportHTML').textContent = lang.exportHTML;
    document.getElementById('langBtn').textContent = lang.langBtn;
    
    // 更新说明文档
    updateDocumentation();
    
    // 更新星期标题 - 根据是否周日第一天来调整
    updateWeekHeaders();
}

function updateDocumentation() {
    const lang = languages[currentLang];
    
    // 更新使用说明
    document.getElementById('usageTitle').textContent = lang.usageTitle;
    const usageList = document.getElementById('usageList');
    usageList.innerHTML = '';
    lang.usageContent.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        usageList.appendChild(li);
    });
    
    // 更新理论基础
    document.getElementById('theoryTitle').innerHTML = `<span class="collapse-arrow">▶</span> ${lang.theoryTitle}`;
    document.getElementById('theoryToggle').textContent = lang.theoryToggle;
    document.getElementById('theoryIntro').textContent = lang.theoryIntro;
    document.getElementById('theoryProcess').textContent = lang.theoryProcess;
    document.getElementById('theoryResults').textContent = lang.theoryResults;
    
    const theoryDataList = document.getElementById('theoryDataList');
    theoryDataList.innerHTML = '';
    lang.theoryData.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        theoryDataList.appendChild(li);
    });
    
    document.getElementById('theoryConclusion').textContent = lang.theoryConclusion;
}

// 切换理论基础部分的显示/隐藏
function toggleTheorySection() {
    const content = document.getElementById('theoryContent');
    const arrow = document.querySelector('.collapse-arrow');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        arrow.classList.remove('expanded');
        arrow.textContent = '▶';
    } else {
        content.classList.add('expanded');
        arrow.classList.add('expanded');
        arrow.textContent = '▼';
    }
}

function updateWeekHeaders() {
    const lang = languages[currentLang];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const daysToShow = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    for (let i = 0; i < 7; i++) {
        document.getElementById('day' + i).textContent = daysToShow[i];
    }
}

function renderCalendar(){
    const book = document.getElementById("book").value;
    const startDate = document.getElementById("startDate").value;
    const listPerDay = parseInt(document.getElementById("listPerDay").value);
    const totalList = parseInt(document.getElementById("totalList").value);
    const reverse = document.getElementById("reverse").checked;
    const colorEnabled = document.getElementById("colorEnabled").checked;
    const sundayFirst = document.getElementById("sundayFirst").checked;
    
    // 解析自定义复习间隔
    const intervalInput = document.getElementById("reviewInterval").value;
    let reviewIntervals;
    try {
        reviewIntervals = intervalInput.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
        if (reviewIntervals.length === 0) {
            reviewIntervals = [0, 1, 3, 7, 14, 25]; // 默认间隔
        }
    } catch (e) {
        reviewIntervals = [0, 1, 3, 7, 14, 25]; // 出错时使用默认间隔
    }
    
    const startDateObj = new Date(startDate);
    let weekday = startDateObj.getDay();
    
    // 如果不是周日第一天，需要调整
    if (!sundayFirst) {
        weekday = (weekday + 6) % 7; // 转换为周一第一天的索引
    }
    
    // 更新星期标题
    updateWeekHeaders();
    
    const firstLineSunday = new Date(startDateObj.getTime() - weekday * 86400000);
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = '';
    
    document.getElementById("mainTitle").textContent = document.getElementById("plan").value || languages[currentLang].mainTitle;
    
    // 计算需要的总天数
    const studyDays = Math.ceil(totalList / listPerDay); // 学习天数
    const maxInterval = Math.max(...reviewIntervals); // 最大复习间隔
    const lastReviewDay = weekday + studyDays - 1 + maxInterval; // 最后一个复习任务的日期索引
    const totalDays = Math.ceil((lastReviewDay + 1) / 7) * 7; // 向上取整到完整的周
    
    for (let i = 0; i < totalDays; i++) {
        const currentDay = new Date(firstLineSunday.getTime() + i * 86400000);
        const dayDiv = document.createElement("div");
        dayDiv.innerHTML = (currentDay.getMonth() + 1) + "/" + currentDay.getDate();
        calendar.appendChild(dayDiv);
    }

    // 新学任务
    const plan = [];
    for (let i = 0; i < Math.ceil(totalList / listPerDay); i++){
        const tmp = [];
        for (let j = 1; j <= listPerDay; j++){
            const k = i * listPerDay + j;
            if(k > totalList) break;
            tmp.push(k);
        }
        const str = tmp.length === 1 ? tmp[0] : tmp[0] + "~" + tmp[tmp.length - 1];
        plan.push(str);
    }
    
    for (let i = 0; i < plan.length; i++){
        let content = '&nbsp;&nbsp;' + book + ' ' + plan[reverse ? plan.length - i - 1 : i];
        if(colorEnabled){
            content = '<span class="new-study">' + content + '</span>';
        }
        if (weekday + i < calendar.children.length) {
            calendar.children[weekday + i].innerHTML += '<br>' + content;
        }
    }

    // 复习任务 - 使用自定义间隔
    const plan2 = [...plan];
    for (let i = 0; i < plan2.length; i++){
        let reviewContent = '*' + book + ' ' + plan2[reverse ? plan2.length - i - 1 : i];
        if(colorEnabled){
            reviewContent = '<span class="review">' + reviewContent + '</span>';
        }
        reviewIntervals.forEach(offset => {
            const targetIndex = weekday + i + offset;
            if (targetIndex < calendar.children.length) {
                calendar.children[targetIndex].innerHTML += '<br>' + reviewContent;
            }
        });
    }
}

// 初始化
loadSettings(); // 先加载保存的设置
document.getElementById("reviewInterval").title = languages[currentLang === 'zh' ? 'zh' : 'en'].intervalLabel;
updateLanguage();
renderCalendar();

// 事件监听 - 添加保存设置
document.getElementById("sidebar").addEventListener("input", function() {
    saveSettings();
    renderCalendar();
});
document.getElementById("sidebar").addEventListener("change", function() {
    saveSettings();
    renderCalendar();
});
document.getElementById("restoreDefaultReviewInterval").addEventListener("click", function(e) {
    e.preventDefault(); 
    renderCalendar();
});

// 获取安全的文件名
function getSafeFileName() {
    const planName = document.getElementById("plan").value.trim();
    const fileName = planName || languages[currentLang].mainTitle;
    return fileName.replace(/[<>:"/\\|?*]/g, '-'); // 替换不安全的文件名字符
}

// 导出PNG
document.getElementById("exportPNG").addEventListener("click", function(){
    // 创建一个临时容器包含标题和日历
    const tempContainer = document.createElement("div");
    tempContainer.style.cssText = `
        position: absolute;
        top: -9999px;
        left: -9999px;
        background: white;
        padding: 20px;
        font-family: Verdana;
    `;
    
    // 复制标题
    const titleClone = document.getElementById("mainTitle").cloneNode(true);
    titleClone.style.cssText = "text-align: center; margin-bottom: 20px; font-size: 24px; color: #333;";
    
    // 复制日历输出区域
    const outputClone = document.getElementById("output").cloneNode(true);
    
    // 更新克隆元素中的星期标题，确保与当前设置一致
    const lang = languages[currentLang];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const daysToShow = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    for (let i = 0; i < 7; i++) {
        const daySpan = outputClone.querySelector('#day' + i);
        if (daySpan) {
            daySpan.textContent = daysToShow[i];
        }
    }
    
    tempContainer.appendChild(titleClone);
    tempContainer.appendChild(outputClone);
    document.body.appendChild(tempContainer);
    
    html2canvas(tempContainer, {
        backgroundColor: 'white',
        scale: 2 // 提高清晰度
    }).then(canvas => {
        const link = document.createElement("a");
        link.download = getSafeFileName() + ".png";
        link.href = canvas.toDataURL("image/png");
        link.click();
        
        // 清理临时容器
        document.body.removeChild(tempContainer);
    });
});

// 导出PDF
document.getElementById("exportPDF").addEventListener("click", function(){
    // 创建一个临时容器包含标题和日历
    const tempContainer = document.createElement("div");
    tempContainer.style.cssText = `
        position: absolute;
        top: -9999px;
        left: -9999px;
        background: white;
        padding: 20px;
        font-family: Verdana;
        width: 750px;
    `;
    
    // 复制标题
    const titleClone = document.getElementById("mainTitle").cloneNode(true);
    titleClone.style.cssText = "text-align: center; margin-bottom: 20px; font-size: 24px; color: #333;";
    
    // 复制日历输出区域并调整样式
    const outputClone = document.getElementById("output").cloneNode(true);

    // 更新克隆元素中的星期标题，确保与当前设置一致
    const lang = languages[currentLang];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const daysToShow = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    for (let i = 0; i < 7; i++) {
        const daySpan = outputClone.querySelector('#day' + i);
        if (daySpan) {
            daySpan.textContent = daysToShow[i];
        }
    }

    tempContainer.appendChild(titleClone);
    tempContainer.appendChild(outputClone);
    document.body.appendChild(tempContainer);
    
    html2canvas(tempContainer, {
        backgroundColor: 'white',
        scale: 1.5, // 适中的缩放比例
        useCORS: true,
        allowTaint: true,
        width: 750,
        height: tempContainer.scrollHeight + 40
    }).then(canvas => {
        const { jsPDF } = window.jspdf;
        
        // 计算PDF尺寸 - 使用A4纸张的横向布局
        const imgWidth = 297; // A4纸宽度(mm) - 横向
        const imgHeight = 210; // A4纸高度(mm) - 横向
        
        // 计算图片的实际尺寸（转换为mm）
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        
        // 计算缩放比例，确保图片完全适应页面
        const scaleX = imgWidth / (canvasWidth * 0.264583); // px转mm的比例
        const scaleY = imgHeight / (canvasHeight * 0.264583);
        const scale = Math.min(scaleX, scaleY, 1); // 选择较小的缩放比例，但不放大
        
        // 计算实际显示尺寸
        const displayWidth = (canvasWidth * 0.264583) * scale;
        const displayHeight = (canvasHeight * 0.264583) * scale;
        
        // 居中显示
        const offsetX = (imgWidth - displayWidth) / 2;
        const offsetY = (imgHeight - displayHeight) / 2;
        
        // 创建PDF
        const pdf = new jsPDF('l', 'mm', 'a4'); // 横向A4
        const imgData = canvas.toDataURL('image/png');
        
        pdf.addImage(imgData, 'PNG', offsetX, offsetY, displayWidth, displayHeight);
        pdf.save(getSafeFileName() + ".pdf");
        
        // 清理临时容器
        document.body.removeChild(tempContainer);
    }).catch(error => {
        console.error('PDF导出失败:', error);
        // 清理临时容器
        if (document.body.contains(tempContainer)) {
            document.body.removeChild(tempContainer);
        }
        alert('PDF导出失败，请重试');
    });
});

// 导出Excel
document.getElementById("exportExcel").addEventListener("click", function(){
    const rows = [];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const lang = languages[currentLang];
    const weekDays = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    rows.push(weekDays);
    let row = [];
    
    Array.from(document.querySelectorAll("#calendar div")).forEach((el, i) => {
        row.push(el.textContent.replace(/\n/g, " | "));
        if((i + 1) % 7 === 0){ 
            rows.push(row); 
            row = []; 
        }
    });
    
    if (row.length > 0) rows.push(row);
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Plan");
    XLSX.writeFile(wb, getSafeFileName() + ".xlsx");
});

// 导出HTML - 只导出表格部分
document.getElementById("exportHTML").addEventListener("click", function(){
    const planTitle = document.getElementById("plan").value || languages[currentLang].mainTitle;
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const lang = languages[currentLang];
    const weekDays = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    let htmlContent = `<!DOCTYPE html>
<html>
<head>
<title>${planTitle}</title>
<meta charset="UTF-8">
<style>
body { font-family: Verdana, sans-serif; margin: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
.calendar-container { 
    border-left: 1px solid #aaa; 
    font-size: 12px; 
    width: 700px;
    margin: 0 auto;
}
.week-header {
    width: 100%;
    overflow: hidden;
}
.day-header { 
    width: 100px; 
    float: left; 
    height: 20px; 
    border: 1px solid #aaa; 
    border-left: none; 
    text-align: center;
    background-color: #f5f5f5;
    font-weight: bold;
    line-height: 20px;
    box-sizing: border-box;
}
.week-row {
    width: 100%;
    overflow: hidden;
}
.day-cell { 
    width: 100px; 
    height: 114px; 
    float: left; 
    padding: 3px; 
    border: 1px solid #aaa; 
    border-left: none;
    border-top: none;
    overflow: hidden;
    box-sizing: border-box;
    font-size: 12px;
}
.new-study { color: #007700; font-weight: bold; }
.review { color: #aa0000; }
@media print { body { margin: 0; } }
</style>
</head>
<body>
<h1>${planTitle}</h1>
<div class="calendar-container">
    <div class="week-header">`;

    // 添加星期标题
    weekDays.forEach(day => {
        htmlContent += `<div class="day-header">${day}</div>`;
    });
    
    htmlContent += `</div>`;
    
    // 添加日期格子 - 按周分行
    const calendarDivs = Array.from(document.querySelectorAll("#calendar div"));
    for (let i = 0; i < calendarDivs.length; i += 7) {
        htmlContent += `<div class="week-row">`;
        for (let j = 0; j < 7 && (i + j) < calendarDivs.length; j++) {
            const el = calendarDivs[i + j];
            htmlContent += `<div class="day-cell">${el.innerHTML}</div>`;
        }
        htmlContent += `</div>`;
    }
    
    htmlContent += `</div>
</body>
</html>`;
    
    const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = getSafeFileName() + ".html";
    link.click();
});
</script>
</body>
</html>
