<!DOCTYPE html>
<html>
<head>
<title id="pageTitle">学习计划时间表生成器</title>
<meta charset="UTF-8">
<style>
a{text-decoration: none;color:#39f; }
body{width: 988px; margin: 0 auto;}
th{text-align: right; font-size: 14px; color: #666;width: 100px;}
td{font-size: 12px;color: #999;padding: 3px 0;}
input{width: 136px;}
input[type=checkbox]{width:auto;}
select{width: 142px;}
h1{text-align: center;}
#sidebar{float: left;width: 270px;margin-right: 10px;margin-top: 70px;}
#output{width: 707px;font-family: Verdana;float: left;font-size: 12px;}
#output>span{
	width: 100px;
	float: left;
	height: 20px;
	border: 1px solid #aaa;
	border-left: none;
	text-align: center;
}
#output{border-left: 1px solid #aaa;}
#calendar>div{
	width: 97px;
	height: 114px;
	float: left;
	padding-left: 3px;
	border-right: 1px solid #aaa;
	border-bottom: 1px solid #aaa;
}
@media print{form{display: none;}body{width: 708px;}}

/* 颜色区分样式 */
.new-study { color: #007700; font-weight: bold; }
.review { color: #aa0000; }

/* 语言切换按钮样式 */
.lang-switch {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
}
.lang-switch:hover {
    background: #e0e0e0;
}
</style>
</head>
<body>

<button class="lang-switch" onclick="toggleLanguage()" id="langBtn">English</button>

<form id="sidebar">
    <table>
        <tbody>
        <tr><th id="planLabel">计划名</th><td><input id="plan" value="Your title"></td></tr>
        <tr><th id="bookLabel">List 名</th><td><input id="book" value="L"></td></tr>
        <tr><th id="startDateLabel">开始日期</th><td><input id="startDate" type="date"></td></tr>
        <tr><th id="listPerDayLabel">每天 List 数</th><td><input id="listPerDay" value="2"></td></tr>
        <tr><th id="totalListLabel">List 总数</th><td><input id="totalList" value="42"></td></tr>
        <tr><th id="reverseLabel">是否逆序</th><td><input id="reverse" type="checkbox"></td></tr>
        <tr><th id="colorLabel">颜色区分</th><td><input id="colorEnabled" type="checkbox" checked></td></tr>
        <tr><th id="weekStartLabel">周日第一天</th><td><input id="sundayFirst" type="checkbox" ></td></tr>
        <tr><th id="actionLabel">操作</th><td>
            <button type="button" id="generate">生成</button>
            <button type="button" onclick="window.print()" id="printBtn">打印</button>
            <button type="button" id="exportPNG">导出PNG</button>
            <button type="button" id="exportPDF">导出PDF</button>
            <button type="button" id="exportExcel">导出Excel</button>
            <button type="button" id="exportHTML">导出HTML</button>
        </td></tr>
        </tbody>
    </table>
    <br>
</form>

<h1 id="mainTitle">学习计划时间表生成器</h1>
<div id="output">
    <span id="day0">Sun</span><span id="day1">Mon</span><span id="day2">Tue</span>
    <span id="day3">Wed</span><span id="day4">Thu</span><span id="day5">Fri</span><span id="day6">Sat</span>
    <div id="calendar"></div>
</div>

<script src="./js/jquery-latest.min.js"></script>
<script src="./js/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="./js/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./js/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// 语言配置
const languages = {
    zh: {
        pageTitle: "学习计划时间表生成器",
        mainTitle: "学习计划时间表生成器",
        planLabel: "计划名",
        bookLabel: "List 名",
        startDateLabel: "开始日期",
        listPerDayLabel: "每天 List 数",
        totalListLabel: "List 总数",
        reverseLabel: "是否逆序",
        colorLabel: "颜色区分",
        weekStartLabel: "周日第一天",
        actionLabel: "操作",
        generate: "生成",
        printBtn: "打印",
        exportPNG: "导出PNG",
        exportPDF: "导出PDF",
        exportExcel: "导出Excel",
        exportHTML: "导出HTML",
        langBtn: "English",
        days: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
        daysLong: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"]
    },
    en: {
        pageTitle: "Study Plan Calendar Generator",
        mainTitle: "Study Plan Calendar Generator",
        planLabel: "Plan Name",
        bookLabel: "List Name",
        startDateLabel: "Start Date",
        listPerDayLabel: "Lists per Day",
        totalListLabel: "Total Lists",
        reverseLabel: "Reverse Order",
        colorLabel: "Color Coding",
        weekStartLabel: "Sunday First",
        actionLabel: "Actions",
        generate: "Generate",
        printBtn: "Print",
        exportPNG: "Export PNG",
        exportPDF: "Export PDF",
        exportExcel: "Export Excel",
        exportHTML: "Export HTML",
        langBtn: "中文",
        days: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        daysLong: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
    }
};

let currentLang = 'zh';

function toggleLanguage() {
    currentLang = currentLang === 'zh' ? 'en' : 'zh';
    updateLanguage();
    renderCalendar();
}

function updateLanguage() {
    const lang = languages[currentLang];
    
    // 更新页面标题和各种标签
    document.getElementById('pageTitle').textContent = lang.pageTitle;
    document.getElementById('mainTitle').textContent = lang.mainTitle;
    document.getElementById('planLabel').textContent = lang.planLabel;
    document.getElementById('bookLabel').textContent = lang.bookLabel;
    document.getElementById('startDateLabel').textContent = lang.startDateLabel;
    document.getElementById('listPerDayLabel').textContent = lang.listPerDayLabel;
    document.getElementById('totalListLabel').textContent = lang.totalListLabel;
    document.getElementById('reverseLabel').textContent = lang.reverseLabel;
    document.getElementById('colorLabel').textContent = lang.colorLabel;
    document.getElementById('weekStartLabel').textContent = lang.weekStartLabel;
    document.getElementById('actionLabel').textContent = lang.actionLabel;
    document.getElementById('generate').textContent = lang.generate;
    document.getElementById('printBtn').textContent = lang.printBtn;
    document.getElementById('exportPNG').textContent = lang.exportPNG;
    document.getElementById('exportPDF').textContent = lang.exportPDF;
    document.getElementById('exportExcel').textContent = lang.exportExcel;
    document.getElementById('exportHTML').textContent = lang.exportHTML;
    document.getElementById('langBtn').textContent = lang.langBtn;
    
    // 更新星期标题 - 根据是否周日第一天来调整
    updateWeekHeaders();
}

function updateWeekHeaders() {
    const lang = languages[currentLang];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const daysToShow = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    for (let i = 0; i < 7; i++) {
        document.getElementById('day' + i).textContent = daysToShow[i];
    }
}

function renderCalendar(){
    const book = document.getElementById("book").value;
    const startDate = document.getElementById("startDate").value;
    const listPerDay = parseInt(document.getElementById("listPerDay").value);
    const totalList = parseInt(document.getElementById("totalList").value);
    const reverse = document.getElementById("reverse").checked;
    const colorEnabled = document.getElementById("colorEnabled").checked;
    const sundayFirst = document.getElementById("sundayFirst").checked;
    
    const startDateObj = new Date(startDate);
    let weekday = startDateObj.getDay();
    
    // 如果不是周日第一天，需要调整
    if (!sundayFirst) {
        weekday = (weekday + 6) % 7; // 转换为周一第一天的索引
    }
    
    // 更新星期标题
    updateWeekHeaders();
    
    const firstLineSunday = new Date(startDateObj.getTime() - weekday * 86400000);
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = '';
    
    document.getElementById("mainTitle").textContent = document.getElementById("plan").value || languages[currentLang].mainTitle;
    
    const totalDays = Math.ceil(totalList / listPerDay) + 25 + weekday;
    
    for (let i = 0; i < totalDays; i++) {
        const currentDay = new Date(firstLineSunday.getTime() + i * 86400000);
        const dayDiv = document.createElement("div");
        dayDiv.innerHTML = (currentDay.getMonth() + 1) + "/" + currentDay.getDate();
        calendar.appendChild(dayDiv);
    }

    // 新学任务
    const plan = [];
    for (let i = 0; i < Math.ceil(totalList / listPerDay); i++){
        const tmp = [];
        for (let j = 1; j <= listPerDay; j++){
            const k = i * listPerDay + j;
            if(k > totalList) break;
            tmp.push(k);
        }
        const str = tmp.length === 1 ? tmp[0] : tmp[0] + "~" + tmp[tmp.length - 1];
        plan.push(str);
    }
    
    for (let i = 0; i < plan.length; i++){
        let content = '&nbsp;&nbsp;' + book + ' ' + plan[reverse ? plan.length - i - 1 : i];
        if(colorEnabled){
            content = '<span class="new-study">' + content + '</span>';
        }
        calendar.children[weekday + i].innerHTML += '<br>' + content;
    }

    // 复习任务
    const plan2 = [...plan];
    for (let i = 0; i < plan2.length; i++){
        let reviewContent = '*' + book + ' ' + plan2[reverse ? plan2.length - i - 1 : i];
        if(colorEnabled){
            reviewContent = '<span class="review">' + reviewContent + '</span>';
        }
        [0, 1, 3, 7, 14, 25].forEach(offset => {
            const targetIndex = weekday + i + offset;
            if (targetIndex < calendar.children.length) {
                calendar.children[targetIndex].innerHTML += '<br>' + reviewContent;
            }
        });
    }
}

// 初始化
document.getElementById("startDate").value = new Date().toISOString().slice(0, 10);
updateLanguage();
renderCalendar();

// 事件监听
document.getElementById("sidebar").addEventListener("input", renderCalendar);
document.getElementById("sidebar").addEventListener("change", renderCalendar);
document.getElementById("generate").addEventListener("click", function(e) {
    e.preventDefault(); 
    renderCalendar();
});

// 获取安全的文件名
function getSafeFileName() {
    const planName = document.getElementById("plan").value || languages[currentLang].mainTitle;
    return planName.replace(/[<>:"/\\|?*]/g, '-'); // 替换不安全的文件名字符
}

// 导出PNG
document.getElementById("exportPNG").addEventListener("click", function(){
    html2canvas(document.querySelector("#output")).then(canvas => {
        const link = document.createElement("a");
        link.download = getSafeFileName() + ".png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
});

// 导出PDF
document.getElementById("exportPDF").addEventListener("click", function(){
    html2canvas(document.querySelector("#output")).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'pt', [canvas.width, canvas.height]);
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save(getSafeFileName() + ".pdf");
    });
});

// 导出Excel
document.getElementById("exportExcel").addEventListener("click", function(){
    const rows = [];
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const lang = languages[currentLang];
    const weekDays = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    rows.push(weekDays);
    let row = [];
    
    Array.from(document.querySelectorAll("#calendar div")).forEach((el, i) => {
        row.push(el.textContent.replace(/\n/g, " | "));
        if((i + 1) % 7 === 0){ 
            rows.push(row); 
            row = []; 
        }
    });
    
    if (row.length > 0) rows.push(row);
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Plan");
    XLSX.writeFile(wb, getSafeFileName() + ".xlsx");
});

// 导出HTML - 只导出表格部分
document.getElementById("exportHTML").addEventListener("click", function(){
    const planTitle = document.getElementById("plan").value || languages[currentLang].mainTitle;
    const sundayFirst = document.getElementById("sundayFirst").checked;
    const lang = languages[currentLang];
    const weekDays = sundayFirst ? lang.days : [...lang.days.slice(1), lang.days[0]];
    
    let htmlContent = `<!DOCTYPE html>
<html>
<head>
<title>${planTitle}</title>
<meta charset="UTF-8">
<style>
body { font-family: Verdana, sans-serif; margin: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
.calendar-container { 
    border-left: 1px solid #aaa; 
    font-size: 12px; 
    width: 700px;
    margin: 0 auto;
}
.week-header {
    width: 100%;
    overflow: hidden;
}
.day-header { 
    width: 100px; 
    float: left; 
    height: 20px; 
    border: 1px solid #aaa; 
    border-left: none; 
    text-align: center;
    background-color: #f5f5f5;
    font-weight: bold;
    line-height: 20px;
    box-sizing: border-box;
}
.week-row {
    width: 100%;
    overflow: hidden;
}
.day-cell { 
    width: 100px; 
    height: 114px; 
    float: left; 
    padding: 3px; 
    border: 1px solid #aaa; 
    border-left: none;
    border-top: none;
    overflow: hidden;
    box-sizing: border-box;
    font-size: 12px;
}
.new-study { color: #007700; font-weight: bold; }
.review { color: #aa0000; }
@media print { body { margin: 0; } }
</style>
</head>
<body>
<h1>${planTitle}</h1>
<div class="calendar-container">
    <div class="week-header">`;

    // 添加星期标题
    weekDays.forEach(day => {
        htmlContent += `<div class="day-header">${day}</div>`;
    });
    
    htmlContent += `</div>`;
    
    // 添加日期格子 - 按周分行
    const calendarDivs = Array.from(document.querySelectorAll("#calendar div"));
    for (let i = 0; i < calendarDivs.length; i += 7) {
        htmlContent += `<div class="week-row">`;
        for (let j = 0; j < 7 && (i + j) < calendarDivs.length; j++) {
            const el = calendarDivs[i + j];
            htmlContent += `<div class="day-cell">${el.innerHTML}</div>`;
        }
        htmlContent += `</div>`;
    }
    
    htmlContent += `</div>
</body>
</html>`;
    
    const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = getSafeFileName() + ".html";
    link.click();
});
</script>
</body>
</html>